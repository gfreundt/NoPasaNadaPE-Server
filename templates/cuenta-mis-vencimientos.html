{% extends "ui-pagina-base.html" %}

{% block title %}
    NoPasaNadaPE - Mis Vencimientos
{% endblock title%}


{% block content %}
<!-- Insert tracking id for testing script -->
<div id="test-marker" tracking-id="cuenta-mis-vencimientos" hidden></div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <!-- {% for message in messages %} -->
            {% for category, msg in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ msg }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        <!-- {% endfor %} -->
    {% endif %}
{% endwith %}


<form method="POST" action="">
    <fieldset class="form-group">
        <div class="container my-4">
            <div class="row justify-content-center">

                <!-- Column Titles -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm w-100" style="border: 2px solid #dee2e6;">
                        <div class="card-body text-center p-3">
                            <p class="h4 fw-bold mb-1">Información obtenida de sitios oficiales</p>
                            <p class="text-muted small mb-0">No se pueden modificar manualmente.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm w-100" style="border: 2px solid #dee2e6;">
                        <div class="card-body text-center p-3">
                            <p class="h4 fw-bold mb-1">Ingresa manualmente las fechas</p>
                            <p class="text-muted small mb-0">Te mandaremos alertas de vencimiento.</p>
                        </div>
                    </div>
                </div>

                <!-- Left Column (Brevete, SOAT, Revision Tecnica) -->
                <div class="col-md-6 d-flex flex-column align-items-stretch">
                    {% if data.auto|length > 0 %}
                        {% for i in range(0, data.auto|length) %}
                        <div class="card shadow-sm mb-3 w-100">
                            <div class="card-header py-2 text-white" style="background-color: #2196f3">
                                <h2 class="h6 mb-0">{{ data.auto[i].titulo }}</h2>
                            </div>
                            <div class="card-body py-2">
                                <div class="form-group mb-1">
                                    <label for="autoDate{{ i }}" class="form-label small mb-1">Fecha de Vencimiento</label>
                                    <input type="date"
                                        class="form-control form-control-sm"
                                        id="autoDate{{ i }}"
                                        value="{{ data.auto[i].fecha }}"
                                        readonly >
                                </div>
                                <p class="mt-2 mb-1 small">
                                    Vigencia <span class="fw-bold" id="autoDays{{ i }}"></span>
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="card shadow-sm mb-3 w-100">
                            <div class="card-header py-2 text-white" style="background-color: #2196f3">
                                <h2 class="h6 mb-0">Sin Información de Vencimientos</h2>
                            </div>
                            <div class="card-body py-2">
                                <p>No tenemos información de SOATs, Revisiones Técnicas o Licencia de Conducir.</p>  
                                <p>Si recién te registras, espera tu primer boletín dentro de las proximas 
                                24 horas y regresa en cualquier momento.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Right Column (DNI + Pasaportes/Visas) -->
                <div class="col-md-6 d-flex flex-column align-items-stretch">

                    <!-- DNI -->
                    <div class="card shadow-sm mb-4 w-100">
                        <div class="card-header py-2 text-white" style="background-color: #2196f3">
                            <h2 class="h6 mb-0">DNI</h2>
                        </div>
                        <div class="card-body py-2">
                            <div class="form-group mb-1">
                                <label for="dniDate" class="form-label small mb-1">Fecha de Vencimiento</label>
                                <input type="date" class="form-control form-control-sm" name="dni_fecha" value={{ data.dni.fecha }} id="dniDate" onchange="calculateDays('dniDate', 'dniDays')">
                            </div>
                            <p class="mt-2 mb-1 small">Vigencia <span class="fw-bold" id="dniDays"></span></p>
                        </div>
                    </div>

                    <!-- Pasaportes / Visas -->
                    <div class="card shadow-sm w-100">
                        <div class="card-header py-2 text-white" style="background-color: #2196f3">
                            <h2 class="h6 mb-0">Pasaportes / Visas</h2>
                        </div>
                        <div class="card-body py-2" id="passport-container">
                            <!-- Button stays at the bottom -->
                            <button type="button" class="btn btn-primary btn-sm w-100" id="add-passport-btn" onclick="addPassportSection()">+ Agregar Documento</button>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="row">
                        <div class="col p-4 text-center">
                            <button id="btn-mis-vencimientos-guardar-cambios" type="submit" name="accion" value="guardar" class="btn text-white" style="background-color: #2196f3">
                                Guardar Cambios
                            </button>
                            <button id="btn-mis-vencimientos-volver-sin-guardar" type="submit" name="accion" value="cancelar" class="btn text-white" style="background-color: #dc3545; margin-left: 10px;">
                                Volver sin Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </fieldset>
</form>


<script>
    const passports = {{ data.pasaportes_visas|tojson|safe }};
    document.addEventListener("DOMContentLoaded", () => {
        passports.forEach(p => {
            addPassportSection(p.pais, p.fecha);
        });
    });
</script>

<script src="{{ url_for('static', filename='cuenta-mis-vencimientos.js') }}"></script>
{% endblock content %}
